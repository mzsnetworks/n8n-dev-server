{"createdAt":"2025-09-16T00:39:22.206Z","updatedAt":"2025-09-17T22:16:26.000Z","id":"WE57DAd08Waummfj","name":"MZS EMAIL AI Agent v5","active":false,"isArchived":false,"nodes":[{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"filters":{}},"type":"n8n-nodes-base.gmailTrigger","typeVersion":1.3,"position":[-432,192],"id":"8bc1592b-0318-4c23-870d-37edc3fa3be7","name":"email_received_trigger","credentials":{"gmailOAuth2":{"id":"uQqj4N21at1RxpWD","name":"MZSN Gmail account"}}},{"parameters":{"jsCode":"// Merge subject + snippet, normalize, strip invisibles, lowercase\nconst subject = String($json.Subject ?? \"\");\nconst snippet = String($json.snippet ?? \"\");\n\nlet text = `${subject} ${snippet}`\n  .normalize('NFKC')\n  // strip zero-width / soft hyphens / CGJ that show up in Gmail previews\n  .replace(/[\\u200B-\\u200D\\uFEFF\\u2060\\u00AD\\u034F]/g, '')\n  .toLowerCase();\n\n// keywords to match (word boundaries to avoid false positives)\nconst keywords = [\n  \"service\",\"services\",\"price\",\"cost\",\"quote\",\"automation\",\"network\",\n  \"help\",\"question\",\"inquiry\",\"business\",\"hours\",\"contact\",\"consulting\",\"support\"\n];\nconst pattern = new RegExp(`\\\\b(${keywords.join('|')})\\\\b`, 'i');\nconst should_process = pattern.test(text);\n\nreturn [{\n  json: {\n    ...$json,\n    prefilter_text: text,\n    should_process\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,192],"id":"bd7e9d27-6204-4cbe-8263-e40f7b2a7384","name":"Analyze_Email"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1d3a9292-2fa8-44f6-9f76-dc2f339f743a","leftValue":"={{ $json.should_process }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-48,192],"id":"8fdf325d-88df-4824-9ea0-192d4d1958ba","name":"Pre-Filter Business Emails"},{"parameters":{"promptType":"define","text":"=Email Message Id: `{{ $json.id }}`\nEmail Thread Id: `{{ $json.threadId }}`\nSender / From: `{{ $json.From }}`\nSubject: `{{ $json.Subject }}`\nTimestamp: `{{ $now.toISO() }}`\nMessage: `{{ $json.snippet }}`","options":{"systemMessage":"You are an email assistant for a network engineering company. Analyze emails and decide if they need responses.\n\nRESPOND IF email asks about:\n- Services (network automation, optimization, consulting)\n- Pricing or quotes\n- Contact info or business hours\n- Service areas\n\nDO NOT RESPOND IF:\n- Personal conversations\n- Spam/promotional\n- Technical support requests\n- Billing disputes\n\nProcess:\n1. Analyze email type and make decision directly\n2. If responding: call get_knowledge_base_cached to get company info.\n3. Format the response by ALWAYS calling format_html_message before sending.\n4. Then call send_email with the formatted HTML output.\n5. ALWAYS call mark_email_read and provide the MessageID parameter with the exact Email Message Id after processing any email.\n6. Log all actions.\n\nBe conservative - only respond when you have clear, accurate info from knowledge base."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[192,176],"id":"70a822b7-92aa-4a46-9b24-17361cebf24c","name":"gmail_agent"},{"parameters":{"jsCode":"// Token Usage and Cost Tracking for Gemini 2.5 Flash\n// Enhanced version that also preserves original email data\n\nconst input = $input.first().json;\n\n// Get the actual output text from the AI agent\nconst outputText = input.output || '';\n\n// Get original email data from the Pre-Filter node\nconst originalEmailData = $('Pre-Filter Business Emails').first().json;\n\n// Estimate input tokens (system message + email content + prompt)\nconst systemMessageLength = 800; // Approximate length of your system message\nconst emailContentLength = (originalEmailData.snippet || '').length;\nconst promptTemplateLength = 200; // Your prompt template\nconst estimatedInputChars = systemMessageLength + emailContentLength + promptTemplateLength;\nconst estimatedInputTokens = Math.ceil(estimatedInputChars / 4);\n\n// Estimate output tokens based on actual response\nconst estimatedOutputTokens = Math.ceil(outputText.length / 4);\nconst estimatedTotalTokens = estimatedInputTokens + estimatedOutputTokens;\n\n// Gemini 2.5 Flash pricing\nconst inputPrice = 0.075;  // per 1M tokens\nconst outputPrice = 0.30;  // per 1M tokens\n\n// Calculate costs\nconst inputCost = (estimatedInputTokens / 1000000) * inputPrice;\nconst outputCost = (estimatedOutputTokens / 1000000) * outputPrice;\nconst totalCost = inputCost + outputCost;\n\n// Create enhanced output with token tracking AND original email data\nconst enhancedOutput = {\n  // Preserve AI agent output\n  ...input,\n  \n  // Add original email data for logging\n  originalEmail: {\n    id: originalEmailData.id,\n    threadId: originalEmailData.threadId,\n    From: originalEmailData.From,\n    Subject: originalEmailData.Subject,\n    snippet: originalEmailData.snippet\n  },\n  \n  // Enhanced token usage\n  tokenUsage: {\n    inputTokens: estimatedInputTokens,\n    outputTokens: estimatedOutputTokens,\n    totalTokens: estimatedTotalTokens,\n    inputCost: parseFloat(inputCost.toFixed(6)),\n    outputCost: parseFloat(outputCost.toFixed(6)),\n    totalCost: parseFloat(totalCost.toFixed(6)),\n    costBreakdown: {\n      inputCostPer1M: inputPrice,\n      outputCostPer1M: outputPrice,\n      calculatedAt: new Date().toISOString(),\n      dataSource: 'text_estimation',\n      estimationNote: 'Estimated at ~4 chars per token'\n    }\n  },\n  \n  // Helper fields for logging\n  hasResponse: Boolean(outputText && outputText.trim().length > 0),\n  processedAt: new Date().toISOString()\n};\n\n// Log the estimation\nconsole.log('=== TOKEN TRACKING WITH EMAIL DATA ===');\nconsole.log('Email Subject:', originalEmailData.Subject);\nconsole.log('Email From:', originalEmailData.From);\nconsole.log('AI Output Length:', outputText.length);\nconsole.log('Token Usage:', {\n  inputTokens: estimatedInputTokens,\n  outputTokens: estimatedOutputTokens,\n  totalTokens: estimatedTotalTokens,\n  totalCostUSD: totalCost.toFixed(6)\n});\nconsole.log('Has Response:', enhancedOutput.hasResponse);\n\nreturn enhancedOutput;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,176],"id":"c078f594-76d8-4f90-8d14-aefe7a769d0a","name":"Track_Tokens_Cost"},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"url","value":"=https://docs.google.com/spreadsheets/d/1M-q0IosysqoI-2S8dffDpncB2fZ2ieUytnV6a64Lyis/edit?gid=0#gid=0","__regex":"https:\\/\\/(?:drive|docs)\\.google\\.com(?:\\/.*|)\\/d\\/([0-9a-zA-Z\\-_]+)(?:\\/.*|)"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1M-q0IosysqoI-2S8dffDpncB2fZ2ieUytnV6a64Lyis/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Timestamp":"={{ $now.format('yyyy-MM-dd hh:mma') }}","Sender":"={{ $json.originalEmail.From || 'Unknown'}}","Subject":"={{ $json.originalEmail.Subject || 'Unknown'}}","Message Preview":"={{ ($json.originalEmail.snippet || '').substring(0, 100) }}","Decision":"={{ $json.hasResponse ? 'RESPOND' : 'NO_RESPONSE' }}","Action Taken":"={{ $json.hasResponse ? 'REPLIED' : 'NO_OP' }}","Input Tokens":"={{ $json.tokenUsage.inputTokens }}","Output Tokens":"={{ $json.tokenUsage.outputTokens }}","Total Tokens":"={{ $json.tokenUsage.totalTokens }}","Input Cost ($)":"={{ $json.tokenUsage.inputCost }}","Output Cost ($)":"={{ $json.tokenUsage.outputCost }}","Total Cost ($)":"={{ $json.tokenUsage.totalCost }} "},"matchingColumns":[],"schema":[{"id":"Timestamp","displayName":"Timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Sender","displayName":"Sender","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Subject","displayName":"Subject","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Message Preview","displayName":"Message Preview","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Decision","displayName":"Decision","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Action Taken","displayName":"Action Taken","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Input Tokens","displayName":"Input Tokens","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Output Tokens","displayName":"Output Tokens","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Total Tokens","displayName":"Total Tokens","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Input Cost ($)","displayName":"Input Cost ($)","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Output Cost ($)","displayName":"Output Cost ($)","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Total Cost ($)","displayName":"Total Cost ($)","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[736,176],"id":"0253b969-58ad-454f-8fa5-d26dabbec60c","name":"Enhanced_Log_Message","credentials":{"googleSheetsOAuth2Api":{"id":"YEsWezEtNkrbQPkC","name":"MZSN Google Sheets account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[928,176],"id":"87b74ab5-c783-41c4-a035-aeb9cf2f6f15","name":"NO-OP"},{"parameters":{"jsCode":"// Log pre-filtered emails\nconst emailData = $input.first().json;\n\nreturn {\n  json: {\n    Timestamp: new Date().toISOString(),\n    Sender: emailData.From || 'Unknown',\n    Subject: emailData.Subject || 'Unknown',\n    'Message Preview': (emailData.snippet || '').substring(0, 100),\n    Decision: 'PRE_FILTERED',\n    'Action Taken': 'NO_OP - Pre-filtered out'\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0],"id":"32b31638-ecbf-4316-8314-498514cb16ed","name":"Log Pre-filtered"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1M-q0IosysqoI-2S8dffDpncB2fZ2ieUytnV6a64Lyis","mode":"list","cachedResultName":"Extended Gmail Agent Log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1M-q0IosysqoI-2S8dffDpncB2fZ2ieUytnV6a64Lyis/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1M-q0IosysqoI-2S8dffDpncB2fZ2ieUytnV6a64Lyis/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Timestamp":"={{ $now.format('yyyy-MM-dd hh:mma') }}","Sender":"={{ $json.Sender }}","Subject":"={{ $json.Subject }}","Message Preview":"={{ $json[\"Message Preview\"] }}","Decision":"={{ $json.Decision }}","Action Taken":"={{ $json[\"Action Taken\"] }}","Input Tokens":"=0","Output Tokens":"=0","Total Tokens":"=0","Input Cost ($)":"=0.00","Output Cost ($)":"=0.00","Total Cost ($)":"=0.00"},"matchingColumns":[],"schema":[{"id":"Timestamp","displayName":"Timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Sender","displayName":"Sender","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Subject","displayName":"Subject","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Message Preview","displayName":"Message Preview","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Decision","displayName":"Decision","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Action Taken","displayName":"Action Taken","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Input Tokens","displayName":"Input Tokens","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Output Tokens","displayName":"Output Tokens","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Total Tokens","displayName":"Total Tokens","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Input Cost ($)","displayName":"Input Cost ($)","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Output Cost ($)","displayName":"Output Cost ($)","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Total Cost ($)","displayName":"Total Cost ($)","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[528,0],"id":"30ef29cf-394e-4fed-b841-f892ee799f33","name":"Log Pre-filtered Sheet","credentials":{"googleSheetsOAuth2Api":{"id":"YEsWezEtNkrbQPkC","name":"MZSN Google Sheets account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-80,464],"id":"6f2dfd30-5033-4c08-b0e7-a64d34e98bca","name":"gemini-2.5-flash-agent","credentials":{"googlePalmApi":{"id":"tv5zC1S3vfzL9v7q","name":"MZSN Google Gemini(PaLM) Api account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.threadId }}"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[80,464],"id":"d76230f9-4233-4f93-831b-c41199942c74","name":"Simple Memory"},{"parameters":{"operation":"get","documentURL":"1YJDJI32blVDTnNZZoQbZ3e6uo7KXintCd8WI3LHlLck"},"type":"n8n-nodes-base.googleDocsTool","typeVersion":2,"position":[256,464],"id":"4e0d5c96-0354-4d3e-a456-1b042b94c6a9","name":"get_knowledge_base_cached","credentials":{"googleDocsOAuth2Api":{"id":"tbCTqogo4I0RSuw2","name":"MZSN Google Docs account"}}},{"parameters":{"jsCode":"// In Agent Tool mode, n8n passes the input text as `query`\nconst text = query || \"\";\n\n// Format into HTML\nlet html = text\n  .replace(/\\n\\n/g, '</p><p>')            // paragraph breaks\n  .replace(/\\n/g, '<br/>')                // single newlines\n  .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')  // bold\n\n// Bullets: lines that start with \"* \"\nhtml = html.replace(/<br\\/>\\*\\s+/g, '<br/><li>');\nhtml = html.replace(/<\\/p><p>\\*\\s+/g, '</p><ul><li>');\n\n// Close <ul> if opened\nif (html.includes('<ul>') && !html.includes('</ul>')) {\n  html += '</ul>';\n}\n\n// Ensure it's wrapped in <p>Ã¢â‚¬Â¦</p>\nif (!html.trim().startsWith('<')) {\n  html = `<p>${html}</p>`;\n}\n\n// Agent tools must return a plain string\nreturn html;"},"type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1.3,"position":[608,464],"id":"7fa862ed-6f09-414d-a1fb-55c2408e475b","name":"format_html_message"},{"parameters":{"operation":"reply","messageId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message_ID', `The email message ID that the customer originally sent in. `, 'string') }}","message":"=<div style=\"font-family: Arial, sans-serif; line-height: 1.5;\">{{ $fromAI('format_html_message') }}</div>","options":{"appendAttribution":false}},"type":"n8n-nodes-base.gmailTool","typeVersion":2.1,"position":[768,464],"id":"199114d4-c02f-4ffd-bfb2-bf95759b9dfb","name":"send_email","webhookId":"548c6a80-2ef5-48ed-ac23-5802f106ac70","credentials":{"gmailOAuth2":{"id":"uQqj4N21at1RxpWD","name":"MZSN Gmail account"}}},{"parameters":{"operation":"markAsRead","messageId":"={{ $fromAI('Message_ID', ``, 'string') }}"},"type":"n8n-nodes-base.gmailTool","typeVersion":2.1,"position":[432,464],"id":"8cc0f8d9-1f35-49bc-9b20-00ea503c15c9","name":"mark_email_read","webhookId":"a8d99d75-b577-48bf-b582-9ced6a55179b","credentials":{"gmailOAuth2":{"id":"uQqj4N21at1RxpWD","name":"MZSN Gmail account"}}}],"connections":{"email_received_trigger":{"main":[[{"node":"Analyze_Email","type":"main","index":0}]]},"Analyze_Email":{"main":[[{"node":"Pre-Filter Business Emails","type":"main","index":0}]]},"Pre-Filter Business Emails":{"main":[[{"node":"gmail_agent","type":"main","index":0}],[{"node":"Log Pre-filtered","type":"main","index":0}]]},"gmail_agent":{"main":[[{"node":"Track_Tokens_Cost","type":"main","index":0}]]},"Track_Tokens_Cost":{"main":[[{"node":"Enhanced_Log_Message","type":"main","index":0}]]},"Enhanced_Log_Message":{"main":[[{"node":"NO-OP","type":"main","index":0}]]},"Log Pre-filtered":{"main":[[{"node":"Log Pre-filtered Sheet","type":"main","index":0}]]},"gemini-2.5-flash-agent":{"ai_languageModel":[[{"node":"gmail_agent","type":"ai_languageModel","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"gmail_agent","type":"ai_memory","index":0}]]},"get_knowledge_base_cached":{"ai_tool":[[{"node":"gmail_agent","type":"ai_tool","index":0}]]},"format_html_message":{"ai_tool":[[{"node":"gmail_agent","type":"ai_tool","index":0}]]},"send_email":{"ai_tool":[[{"node":"gmail_agent","type":"ai_tool","index":0}]]},"mark_email_read":{"ai_tool":[[{"node":"gmail_agent","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"97a725bc-d280-45aa-a734-0c125adf5188","triggerCount":0,"shared":[{"createdAt":"2025-09-16T00:39:22.211Z","updatedAt":"2025-09-16T00:39:22.211Z","role":"workflow:owner","workflowId":"WE57DAd08Waummfj","projectId":"UeEOi7Hou8inJPiR"}],"tags":[{"createdAt":"2025-09-16T05:04:37.883Z","updatedAt":"2025-09-16T05:04:37.883Z","id":"PBx6zUEAVGmQqxX7","name":"Enhanced Logging"},{"createdAt":"2025-09-09T12:25:02.103Z","updatedAt":"2025-09-09T12:25:02.103Z","id":"ZvY80149EbSRGo2O","name":"Agent"},{"createdAt":"2025-09-16T03:40:04.953Z","updatedAt":"2025-09-16T03:40:04.953Z","id":"q6CQiNJgMQEY0Tzu","name":"Commercial Ready"},{"createdAt":"2025-09-13T00:36:34.903Z","updatedAt":"2025-09-13T00:36:34.903Z","id":"rsm4sJR5Kyh0nhJo","name":"Token Optimized"}]}